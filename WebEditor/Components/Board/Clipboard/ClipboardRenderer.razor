@if (_boardData is BoardData board)
{
    <div class="drag-area" draggable="true" style="@X @Y @Width @Height">

        @foreach (Position position in board.Tiles)
        {
            bool top = !board.Tiles.Contains(position + new Position(0, -1));
            bool bottom = !board.Tiles.Contains(position + new Position(0, 1));
            bool left = !board.Tiles.Contains(position + new Position(-1, 0));
            bool right = !board.Tiles.Contains(position + new Position(1, 0));
            Position tranlated = position - _boardOffset + new Position(1, 1);
            <div class="selected-cell" left="@left" right="@right" top="@top" bottom="@bottom" style="grid-column: @(tranlated.X); grid-row: @(tranlated.Y);" @onclick="(args => UnselectTile(args, position))" />
        }
        <div class="board-data">
            <BoardRenderer Width="@_boundingBox.Width" Height="@_boundingBox.Height" Board="@board" Zoom="@Parent.Zoom" ShowGrid="@false" Offset="@_boardOffset" />
        </div>
    </div>
}

@code {
    [CascadingParameter]
    public required BoardRenderer Parent { get; set; }

    private string X => $"--x: {_boundingBox.TopLeft.X};";
    private string Y => $"--y: {_boundingBox.TopLeft.Y};";
    private string Width => $"--width: {_boundingBox.Width};";
    private string Height => $"--height: {_boundingBox.Height};";

    private BoundingBox _boundingBox = new();
    private Position _boardOffset = new();
    private BoardData? _boardData = null;

    public void Clear() => _boardData = null;

    public void AddSelection(BoundingBox toAdd)
    {
        if (_boardData is null) { InitializeSelection(toAdd); }
        else
        {
            Position offset = toAdd.TopLeft - _boundingBox.TopLeft + _boardOffset;
            BoardData selected = Parent.Board.GetSelection(toAdd);
            _boardData.AddAll(selected, offset);
            _boardOffset = new Position()
                {
                    X = Math.Min(_boardOffset.X, offset.X),
                    Y = Math.Min(_boardOffset.Y, offset.Y),
                };
            _boundingBox = _boundingBox.Fit(toAdd);
        }
        StateHasChanged();
    }

    private void UnselectTile(MouseEventArgs args, Position position)
    {
        if (!args.ShiftKey) { return; }
        if (_boardData[position].Figure is Positioned<Figure> figure)
        {
            _boardData.RemoveTiles(figure.BoundingBox().Positions());
        }
        else
        {
            _boardData.RemoveTile(position);
        }
        StateHasChanged();
    }

    private void InitializeSelection(BoundingBox toAdd)
    {
        _boardOffset = new Position(0, 0);
        _boardData = Parent.Board.GetSelection(toAdd);
        _boundingBox = toAdd;
    }
}
